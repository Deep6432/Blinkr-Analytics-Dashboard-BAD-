{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Disbursal Summary - Edge Analytics Dashboard{% endblock %}

{% block page_title %}Disbursal Summary{% endblock %}
{% block page_subtitle %}Advanced performance insights and data visualization{% endblock %}

{% block content %}
<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Disbursal by State Chart -->
    <div class="bg-white dark:bg-slate-800/50 border border-gray-200 dark:border-slate-700 rounded-2xl p-6 shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden relative">
        <div class="absolute left-0 top-0 bottom-0 w-1" style="background-color: #00072D;"></div>
        <div class="flex items-center justify-between mb-5">
            <div>
                <h3 class="text-lg font-bold mb-1.5 tracking-tight" style="color: #00072D;">Disbursal by State</h3>
                <p class="text-xs text-gray-500 dark:text-slate-400 font-medium uppercase tracking-wide">Distribution across states</p>
            </div>
            <div class="flex items-center gap-2">
                <button 
                    onclick="downloadChart('stateChart')"
                    class="p-2 rounded-lg transition-all duration-200 hover:opacity-80"
                    style="background-color: rgba(0, 7, 45, 0.1); color: #00072D;"
                    aria-label="Download chart"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="relative h-80">
            <canvas id="stateChart"></canvas>
        </div>
        <!-- Scrollable Legend -->
        <div id="stateLegend" class="mt-4 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
            <!-- Legend will be populated by Chart.js -->
        </div>
    </div>
    
    <!-- Disbursal by City Chart -->
    <div class="bg-white dark:bg-slate-800/50 border border-gray-200 dark:border-slate-700 rounded-2xl p-6 shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden relative">
        <div class="absolute left-0 top-0 bottom-0 w-1" style="background-color: #00072D;"></div>
        <div class="flex items-center justify-between mb-5">
            <div>
                <h3 class="text-lg font-bold mb-1.5 tracking-tight" style="color: #00072D;">Disbursal by City</h3>
                <p class="text-xs text-gray-500 dark:text-slate-400 font-medium uppercase tracking-wide">Distribution across cities</p>
            </div>
            <div class="flex items-center gap-2">
                <button 
                    onclick="downloadChart('cityChart')"
                    class="p-2 rounded-lg transition-all duration-200 hover:opacity-80"
                    style="background-color: rgba(0, 7, 45, 0.1); color: #00072D;"
                    aria-label="Download chart"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="relative h-80">
            <canvas id="cityChart"></canvas>
        </div>
        <!-- Scrollable Legend -->
        <div id="cityLegend" class="mt-4 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
            <!-- Legend will be populated by Chart.js -->
        </div>
    </div>
</div>

<!-- Empty State (if no data) - Show only if both charts have no data -->
<div id="empty-state" class="hidden bg-white dark:bg-slate-800/50 border border-gray-200 dark:border-slate-700 rounded-xl p-12 text-center shadow-sm">
    <svg class="w-16 h-16 text-gray-400 dark:text-slate-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>
    <h3 class="text-lg font-semibold text-gray-700 dark:text-slate-300 mb-2">No data available</h3>
    <p class="text-gray-500 dark:text-slate-500">No data found for the selected filters. Try adjusting your search criteria.</p>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Cities by state mapping for dynamic city filtering
{% if cities_by_state_json %}
window.citiesByState = {{ cities_by_state_json|safe }};
{% else %}
window.citiesByState = {};
{% endif %}

// Chart data from Django backend
// Backend should provide these as JSON-safe strings or arrays
window.stateData = {
    labels: {{ state_labels|safe|default:"[]" }},
    values: {{ state_values|safe|default:"[]" }},
    sanction: {{ state_sanction|safe|default:"[]" }}
};

window.cityData = {
    labels: {{ city_labels|safe|default:"[]" }},
    values: {{ city_values|safe|default:"[]" }},
    sanction: {{ city_sanction|safe|default:"[]" }}
};

// Chart.js color palette (premium, accessible)
window.chartColors = [
    '#3b82f6', // Blue
    '#10b981', // Green
    '#f59e0b', // Orange
    '#ec4899', // Pink
    '#06b6d4', // Cyan
    '#8b5cf6', // Purple
    '#ef4444', // Red
    '#84cc16', // Lime
    '#f97316', // Orange
    '#14b8a6', // Teal
    '#a855f7', // Purple
    '#eab308', // Yellow
    '#22c55e', // Green
    '#6366f1', // Indigo
    '#06b6d4', // Cyan
    '#f59e0b', // Amber
    '#ec4899', // Pink
    '#ef4444', // Red
];

// Get current theme
function getCurrentTheme() {
    return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
}

// Get tooltip colors based on theme
function getTooltipColors() {
    const theme = getCurrentTheme();
    return theme === 'dark' 
        ? {
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            titleColor: '#f1f5f9',
            bodyColor: '#cbd5e1',
            borderColor: '#334155'
        }
        : {
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            titleColor: '#111827',
            bodyColor: '#374151',
            borderColor: '#e5e7eb'
        };
}

// Function to initialize or update charts - make it global
window.initializeCharts = function() {
    // Destroy existing charts if they exist
    if (window.stateChart) {
        window.stateChart.destroy();
        window.stateChart = null;
    }
    if (window.cityChart) {
        window.cityChart.destroy();
        window.cityChart = null;
    }
    
    // Clear legends
    const stateLegendEl = document.getElementById('stateLegend');
    const cityLegendEl = document.getElementById('cityLegend');
    if (stateLegendEl) stateLegendEl.innerHTML = '';
    if (cityLegendEl) cityLegendEl.innerHTML = '';
    
    // Initialize State Chart
    if (window.stateData && window.stateData.labels.length > 0 && window.stateData.values.length > 0) {
        const stateCtx = document.getElementById('stateChart');
        if (stateCtx) {
            const tooltipColors = getTooltipColors();
            window.stateChart = new Chart(stateCtx, {
                type: 'pie',
                data: {
                    labels: window.stateData.labels,
                    datasets: [{
                        data: window.stateData.values,
                        backgroundColor: window.chartColors.slice(0, window.stateData.labels.length),
                        borderColor: getCurrentTheme() === 'dark' ? 'rgba(15, 23, 42, 0.8)' : 'rgba(255, 255, 255, 0.8)',
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // We'll use custom legend
                        },
                        tooltip: {
                            backgroundColor: tooltipColors.backgroundColor,
                            titleColor: tooltipColors.titleColor,
                            bodyColor: tooltipColors.bodyColor,
                            borderColor: tooltipColors.borderColor,
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label || '';
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const disbursalValue = context.parsed || 0;
                                    const sanctionValue = window.stateData.sanction[index] || 0;
                                    
                                    // Calculate totals for percentages
                                    const totalDisbursal = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const totalSanction = window.stateData.sanction.reduce((a, b) => a + b, 0);
                                    
                                    // Calculate percentages
                                    const disbursalPercentage = totalDisbursal > 0 ? ((disbursalValue / totalDisbursal) * 100).toFixed(1) : '0.0';
                                    const sanctionPercentage = totalSanction > 0 ? ((sanctionValue / totalSanction) * 100).toFixed(1) : '0.0';
                                    
                                    return [
                                        `Sanction Amount: ₹${sanctionValue.toLocaleString('en-IN')} (${sanctionPercentage}%)`,
                                        `Disbursal Amount: ₹${disbursalValue.toLocaleString('en-IN')} (${disbursalPercentage}%)`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
            
            // Custom legend for state chart (show sanction amount)
            if (typeof window.renderCustomLegend === 'function') {
                window.renderCustomLegend('stateLegend', window.stateData.labels, window.stateData.values, window.chartColors, window.stateData.sanction);
            }
        }
    } else {
        window.stateChart = null;
    }
    
    // Initialize City Chart
    if (window.cityData && window.cityData.labels.length > 0 && window.cityData.values.length > 0) {
        const cityCtx = document.getElementById('cityChart');
        if (cityCtx) {
            const tooltipColors = getTooltipColors();
            window.cityChart = new Chart(cityCtx, {
                type: 'pie',
                data: {
                    labels: window.cityData.labels,
                    datasets: [{
                        data: window.cityData.values,
                        backgroundColor: window.chartColors.slice(0, window.cityData.labels.length),
                        borderColor: getCurrentTheme() === 'dark' ? 'rgba(15, 23, 42, 0.8)' : 'rgba(255, 255, 255, 0.8)',
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // We'll use custom legend
                        },
                        tooltip: {
                            backgroundColor: tooltipColors.backgroundColor,
                            titleColor: tooltipColors.titleColor,
                            bodyColor: tooltipColors.bodyColor,
                            borderColor: tooltipColors.borderColor,
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label || '';
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const disbursalValue = context.parsed || 0;
                                    const sanctionValue = window.cityData.sanction[index] || 0;
                                    
                                    // Calculate totals for percentages
                                    const totalDisbursal = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const totalSanction = window.cityData.sanction.reduce((a, b) => a + b, 0);
                                    
                                    // Calculate percentages
                                    const disbursalPercentage = totalDisbursal > 0 ? ((disbursalValue / totalDisbursal) * 100).toFixed(1) : '0.0';
                                    const sanctionPercentage = totalSanction > 0 ? ((sanctionValue / totalSanction) * 100).toFixed(1) : '0.0';
                                    
                                    return [
                                        `Sanction Amount: ₹${sanctionValue.toLocaleString('en-IN')} (${sanctionPercentage}%)`,
                                        `Disbursal Amount: ₹${disbursalValue.toLocaleString('en-IN')} (${disbursalPercentage}%)`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
            
            // Custom legend for city chart (show sanction amount)
            if (typeof window.renderCustomLegend === 'function') {
                window.renderCustomLegend('cityLegend', window.cityData.labels, window.cityData.values, window.chartColors, window.cityData.sanction);
            }
        }
    } else {
        window.cityChart = null;
    }
};

// Initialize charts when page loads - make them global
window.stateChart = null;
window.cityChart = null;

// Function to show/hide empty state
function updateEmptyState() {
    const emptyStateEl = document.getElementById('empty-state');
    const hasStateData = window.stateData && window.stateData.labels.length > 0 && window.stateData.values.length > 0;
    const hasCityData = window.cityData && window.cityData.labels.length > 0 && window.cityData.values.length > 0;
    
    if (emptyStateEl) {
        if (!hasStateData && !hasCityData) {
            emptyStateEl.classList.remove('hidden');
        } else {
            emptyStateEl.classList.add('hidden');
        }
    }
}

// Wait for DOM to be ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        updateEmptyState();
    });
} else {
    initializeCharts();
    updateEmptyState();
}

// Render custom scrollable legend - make it global
window.renderCustomLegend = function(containerId, labels, values, colors, sanctionValues) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // Use sanction values if provided, otherwise use disbursal values
    const displayValues = sanctionValues || values;
    const total = displayValues.reduce((a, b) => a + b, 0);
    container.innerHTML = '';
    
    labels.forEach((label, index) => {
        const sanctionValue = displayValues[index] || 0;
        const percentage = total > 0 ? ((sanctionValue / total) * 100).toFixed(1) : '0.0';
        const color = colors[index % colors.length];
        
        const legendItem = document.createElement('div');
        legendItem.className = 'flex items-center justify-between py-2 px-3 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors';
        legendItem.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="w-4 h-4 rounded" style="background-color: ${color}"></div>
                <span class="text-sm text-gray-700 dark:text-slate-300">${label}</span>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-gray-900 dark:text-slate-200">₹${sanctionValue.toLocaleString('en-IN')}</span>
                <span class="text-xs text-gray-500 dark:text-slate-500">${percentage}%</span>
            </div>
        `;
        container.appendChild(legendItem);
    });
};

// Download chart as PNG
function downloadChart(chartId) {
    const chart = chartId === 'stateChart' ? window.stateChart : window.cityChart;
    if (chart) {
        const url = chart.toBase64Image();
        const link = document.createElement('a');
        link.download = `${chartId}_${new Date().toISOString().split('T')[0]}.png`;
        link.href = url;
        link.click();
    }
}
</script>

<!-- Records Table Modal -->
<div id="records-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeRecordsTable()"></div>

        <!-- Modal panel -->
        <div class="inline-block align-bottom bg-white dark:bg-slate-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-7xl sm:w-full">
            <!-- Modal header -->
            <div class="bg-white dark:bg-slate-800 px-6 py-4 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white" id="modal-title">
                    All Records Data
                </h3>
                <button onclick="closeRecordsTable()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Modal body -->
            <div class="bg-white dark:bg-slate-800 px-6 py-4 max-h-[70vh] overflow-y-auto">
                <!-- Loading state -->
                <div id="records-loading" class="flex items-center justify-center py-12">
                    <div class="flex flex-col items-center gap-4">
                        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <p class="text-gray-600 dark:text-slate-400 text-sm">Loading records...</p>
                    </div>
                </div>

                <!-- Error state -->
                <div id="records-error" class="hidden text-center py-12">
                    <p class="text-red-600 dark:text-red-400 text-sm">Failed to load records. Please try again.</p>
                </div>

                <!-- Search Bar -->
                <div id="records-search-container" class="hidden mb-4">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input 
                            type="text" 
                            id="records-search-input" 
                            placeholder="Search by Mobile, Name, or PAN..." 
                            class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                            onkeyup="filterRecordsTable()"
                        />
                    </div>
                </div>

                <!-- Table container -->
                <div id="records-table-container" class="hidden overflow-x-auto border border-gray-200 dark:border-slate-700 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
                        <thead>
                            <tr id="records-table-header">
                                <!-- Headers will be populated by JavaScript -->
                            </tr>
                        </thead>
                        <tbody id="records-table-body" class="bg-white dark:bg-slate-800 divide-y divide-gray-200 dark:divide-slate-700">
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Modal footer -->
            <div class="bg-gray-50 dark:bg-slate-700 px-6 py-3 border-t border-gray-200 dark:border-slate-600 flex items-center justify-between">
                <div class="text-sm text-gray-600 dark:text-slate-400">
                    <span id="records-count">0</span> records
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="exportToExcel()" id="export-excel-btn" class="px-4 py-2 text-sm font-medium text-white rounded-lg transition-colors hover:opacity-90 flex items-center gap-2" style="background-color: #10b981;">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Export Excel
                    </button>
                    <button onclick="closeRecordsTable()" class="px-4 py-2 text-sm font-medium text-white rounded-lg transition-colors hover:opacity-90" style="background-color: #00072D;">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Record Details Modal -->
<div id="record-details-modal" class="fixed inset-0 z-[60] hidden overflow-y-auto" aria-labelledby="record-details-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeRecordDetails()"></div>

        <!-- Modal panel -->
        <div class="inline-block align-bottom bg-white dark:bg-slate-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
            <!-- Modal header -->
            <div class="bg-white dark:bg-slate-800 px-6 py-4 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white" id="record-details-title">
                    Record Details
                </h3>
                <button onclick="closeRecordDetails()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Modal body -->
            <div class="bg-white dark:bg-slate-800 px-6 py-4 max-h-[70vh] overflow-y-auto">
                <div id="record-details-content" class="space-y-3">
                    <!-- Key-value pairs will be populated here -->
                </div>
            </div>

            <!-- Modal footer -->
            <div class="bg-gray-50 dark:bg-slate-700 px-6 py-3 border-t border-gray-200 dark:border-slate-600 flex justify-end">
                <button onclick="closeRecordDetails()" class="px-4 py-2 text-sm font-medium text-white rounded-lg transition-colors hover:opacity-90" style="background-color: #00072D;">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Records Table Modal Functions
function openRecordsTable() {
    const modal = document.getElementById('records-modal');
    const loading = document.getElementById('records-loading');
    const error = document.getElementById('records-error');
    const tableContainer = document.getElementById('records-table-container');
    
    // Show modal and loading state
    modal.classList.remove('hidden');
    loading.classList.remove('hidden');
    error.classList.add('hidden');
    tableContainer.classList.add('hidden');
    
    // Get current filter parameters
    const urlParams = new URLSearchParams(window.location.search);
    const filters = {
        date_from: urlParams.get('date_from') || '',
        date_to: urlParams.get('date_to') || '',
        state: urlParams.getAll('state'),
        city: urlParams.getAll('city'),
        product: urlParams.get('product') || '',
        credit_person: urlParams.get('credit_person') || ''
    };
    
    // Build API URL
    const apiUrl = new URL('/api/disbursal-records/', window.location.origin);
    Object.keys(filters).forEach(key => {
        if (filters[key]) {
            if (Array.isArray(filters[key])) {
                filters[key].forEach(val => {
                    if (val) apiUrl.searchParams.append(key, val);
                });
            } else if (filters[key]) {
                apiUrl.searchParams.append(key, filters[key]);
            }
        }
    });
    
    // Get token from localStorage
    const token = localStorage.getItem('blinkr_token');
    
    // Fetch records data
    fetch(apiUrl.toString(), {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            ...(token && { 'Authorization': `Bearer ${token}` })
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        loading.classList.add('hidden');
        if (data.error) {
            error.classList.remove('hidden');
            error.textContent = data.error;
        } else {
            displayRecordsTable(data.records || []);
            document.getElementById('records-count').textContent = data.records ? data.records.length : 0;
        }
    })
    .catch(error => {
        console.error('Error fetching records:', error);
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        error.textContent = 'Failed to load records: ' + error.message;
    });
}

function closeRecordsTable() {
    const modal = document.getElementById('records-modal');
    modal.classList.add('hidden');
}

// Store original records for filtering
let allRecordsData = [];

// Define column mapping: [Display Name, API Field Name(s)] - make it global
const columnMapping = [
        ['ID', ['id', 'ID', 'Id', 'loan_id', 'Loan_ID']],
        ['LOAN_NO', ['loan_no', 'Loan_No', 'LOAN_NO', 'loan_number', 'Loan_Number', 'loanNumber', 'loan_id', 'Loan_ID', 'loanId', 'loan_id_number', 'application_id', 'Application_ID', 'application_number', 'Application_Number', 'app_id', 'App_ID']],
        ['FULLNAME', ['fullname', 'FullName', 'full_name', 'FULLNAME', 'name', 'Name', 'customer_name']],
        ['PAN', ['pan', 'PAN', 'Pan', 'pan_number', 'PAN_Number']],
        ['MOBILE', ['mobile', 'Mobile', 'MOBILE', 'phone', 'Phone', 'mobile_number', 'contact_number']],
        ['PERSONAL EMAIL', ['personal_email', 'Personal_Email', 'PERSONAL_EMAIL', 'email', 'Email', 'EMAIL', 'personal_email_id']],
        ['OFFICE EMAIL', ['office_email', 'Office_Email', 'OFFICE_EMAIL', 'office_email_id', 'work_email']],
        ['PINCODE', ['pincode', 'Pincode', 'PINCODE', 'pin_code', 'PIN_CODE', 'postal_code']],
        ['CITY', ['city', 'City', 'CITY']],
        ['STATE', ['state', 'State', 'STATE']],
        ['COUNTRY', ['country', 'Country', 'COUNTRY']],
        ['ADDRESS', ['address', 'Address', 'ADDRESS', 'full_address', 'Full_Address']],
        ['SANCTION DATE', ['sanction_date', 'Sanction_Date', 'SANCTION_DATE', 'sanctiondate', 'loan_sanction_date']],
        ['LOAN AMOUNT', ['loan_amount', 'Loan_Amount', 'LOAN_AMOUNT', 'sanction_amount', 'Sanction_Amount']],
        ['DISBURSAL DATE', ['disbursal_date', 'Disbursal_Date', 'DISBURSAL_DATE', 'disbursaldate', 'disbursement_date', 'DisbursalDate', 'disbursalDate', 'disbursal_dt', 'Disbursal_Dt', 'disbursement_dt', 'disbursalDate', 'disbursal_date_time', 'disbursalDate', 'disbursal_date_ist']],
        ['DISBURSAL AMOUNT', ['Disbursal_Amt', 'disbursal_amount', 'Disbursal_Amount', 'DISBURSAL_AMOUNT', 'disbursal_amt']],
        ['PROCESSING FEE', ['processing_fee', 'Processing_Fee', 'PROCESSING_FEE', 'proc_fee']],
        ['INTEREST AMOUNT', ['interest_amount', 'Interest_Amount', 'INTEREST_AMOUNT', 'interest_amt']],
        ['REPAYMENT DATE', ['repayment_date', 'Repayment_Date', 'REPAYMENT_DATE', 'repay_date']],
        ['REPAYMENT AMOUNT', ['repayment_amount', 'Repayment_Amount', 'REPAYMENT_AMOUNT', 'repay_amount']],
        ['TENURE', ['tenure', 'Tenure', 'TENURE', 'loan_tenure', 'tenure_days']]
];

function displayRecordsTable(records) {
    const tableContainer = document.getElementById('records-table-container');
    const tableHeader = document.getElementById('records-table-header');
    const tableBody = document.getElementById('records-table-body');
    const searchContainer = document.getElementById('records-search-container');
    
    // Store original records
    allRecordsData = records || [];
    
    if (!records || records.length === 0) {
        tableContainer.classList.remove('hidden');
        searchContainer.classList.add('hidden');
        tableBody.innerHTML = '<tr><td colspan="22" class="px-6 py-4 text-center text-gray-500 dark:text-slate-400">No records found</td></tr>';
        return;
    }
    
    // Show search bar
    if (searchContainer) {
        searchContainer.classList.remove('hidden');
    }
    
    // Clear search input
    const searchInput = document.getElementById('records-search-input');
    if (searchInput) {
        searchInput.value = '';
    }
    
    // Build table header first
    if (tableHeader) {
        tableHeader.innerHTML = columnMapping.map(([displayName]) => 
            `<th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider whitespace-nowrap sticky top-0" style="background-color: #00072D;">${displayName}</th>`
        ).join('');
    }
    
    // Display all records initially
    renderTableRecords(records);
    
    // Show table container
    if (tableContainer) {
        tableContainer.classList.remove('hidden');
    }
}

// Helper function to find value in record by trying multiple field names
function getFieldValue(record, fieldNames) {
        // First try exact matches
        for (const fieldName of fieldNames) {
            if (record.hasOwnProperty(fieldName)) {
                return record[fieldName];
            }
        }
        
        // For disbursal date and loan_no, try case-insensitive search
        const displayName = fieldNames[0];
        if (displayName === 'DISBURSAL DATE' || displayName === 'LOAN_NO') {
            const recordKeys = Object.keys(record);
            const lowerKeys = recordKeys.map(k => k.toLowerCase());
            
            // Try case-insensitive match for all field name variations
            for (let i = 0; i < fieldNames.length; i++) {
                const searchKey = fieldNames[i].toLowerCase();
                const index = lowerKeys.indexOf(searchKey);
                if (index !== -1) {
                    console.log(`Found ${displayName} (case-insensitive):`, recordKeys[index], record[recordKeys[index]]);
                    return record[recordKeys[index]];
                }
            }
            
            // Also try common variations for loan_no
            if (displayName === 'LOAN_NO') {
                const loanNoVariations = ['loan_no', 'loanno', 'loan_number', 'loannumber', 'loan_id', 'loanid', 'application_id', 'applicationid', 'application_number', 'applicationnumber', 'app_id', 'appid'];
                for (const variation of loanNoVariations) {
                    const index = lowerKeys.indexOf(variation);
                    if (index !== -1) {
                        console.log('Found LOAN_NO (variation):', recordKeys[index], record[recordKeys[index]]);
                        return record[recordKeys[index]];
                    }
                }
                
                // Try partial matches (contains "loan" and "no" or "number")
                for (const key of recordKeys) {
                    const lowerKey = key.toLowerCase();
                    if ((lowerKey.includes('loan') || lowerKey.includes('application') || lowerKey.includes('app')) && 
                        (lowerKey.includes('no') || lowerKey.includes('number') || lowerKey.includes('num') || lowerKey.includes('id'))) {
                        console.log('Found LOAN_NO (partial match):', key, record[key]);
                        return record[key];
                    }
                }
                
                // Debug: Log all keys if still not found (only log once per record to avoid spam)
                if (!window.loanNoDebugLogged) {
                    console.log('LOAN_NO not found. Available keys in first record:', recordKeys);
                    console.log('Sample record:', record);
                    window.loanNoDebugLogged = true;
                }
            }
            
            // For disbursal date, try partial matches
            if (displayName === 'DISBURSAL DATE') {
                // Try partial matches (contains "disbursal" and "date")
                for (const key of recordKeys) {
                    const lowerKey = key.toLowerCase();
                    if ((lowerKey.includes('disbursal') || lowerKey.includes('disbursement')) && 
                        (lowerKey.includes('date') || lowerKey.includes('dt') || lowerKey.includes('time'))) {
                        console.log('Found disbursal date (partial match):', key, record[key]);
                        return record[key];
                    }
                }
                
                // Debug: Log all keys if still not found
                console.log('Disbursal date not found. Available keys:', recordKeys);
            }
        }
        
        return null;
}

// Helper function to format value
function formatValue(value, columnName) {
        if (value === null || value === undefined || value === '') {
            return '-';
        }
        if (typeof value === 'object') {
            return JSON.stringify(value);
        }
        
        // Handle ID, LOAN_NO, and MOBILE columns - display as plain string, no formatting
        if (columnName === 'ID' || columnName === 'LOAN_NO' || columnName === 'MOBILE') {
            return String(value);
        }
        
        const dateStr = String(value);
        
        // Format dates - handle various date formats (only for date columns)
        const dateColumns = ['SANCTION DATE', 'DISBURSAL DATE', 'REPAYMENT DATE'];
        if (dateColumns.includes(columnName)) {
            // Check for ISO date format (YYYY-MM-DD or YYYY-MM-DDTHH:mm:ss)
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}/)) {
                return dateStr.split('T')[0]; // Remove time if present
            }
            // Check for other date formats (DD-MM-YYYY, DD/MM/YYYY, etc.)
            if (dateStr.match(/^\d{2}[-\/]\d{2}[-\/]\d{4}/)) {
                return dateStr;
            }
            // Check for timestamp (milliseconds or seconds)
            if (!isNaN(value) && (String(value).length === 10 || String(value).length === 13)) {
                const timestamp = String(value).length === 10 ? parseFloat(value) * 1000 : parseFloat(value);
                const date = new Date(timestamp);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
            }
        }
        
        // Handle PINCODE - no comma formatting
        if (columnName === 'PINCODE') {
            return String(value);
        }
        
        // Handle amount columns - add rupee sign and format with commas
        const amountColumns = ['LOAN AMOUNT', 'DISBURSAL AMOUNT', 'PROCESSING FEE', 'INTEREST AMOUNT', 'REPAYMENT AMOUNT'];
        if (amountColumns.includes(columnName)) {
            if (typeof value === 'number' || (!isNaN(value) && !isNaN(parseFloat(value)))) {
                const num = parseFloat(value);
                return '₹' + num.toLocaleString('en-IN', { maximumFractionDigits: 2 });
            }
            return '₹' + String(value);
        }
        
        // Format other numbers with commas (but exclude ID, MOBILE, PINCODE, and date columns)
        if (typeof value === 'number' || (!isNaN(value) && !isNaN(parseFloat(value)) && !dateStr.match(/^\d{4}-\d{2}-\d{2}/))) {
            const num = parseFloat(value);
            // Only format if it's a number and not a date-like string
            if (num >= 1000 && !dateColumns.includes(columnName)) {
                return num.toLocaleString('en-IN', { maximumFractionDigits: 2 });
            }
            return num.toString();
        }
        
        return String(value);
}

// Function to render table records
function renderTableRecords(records) {
    const tableBody = document.getElementById('records-table-body');
    const tableHeader = document.getElementById('records-table-header');
    
    if (!tableBody || !tableHeader) return;
    
    // Store records for detail view (before building rows)
    window.currentDisplayedRecords = records;
    
    // Build table rows with click handlers
    tableBody.innerHTML = records.map((record, index) => {
        return `<tr class="hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors border-b border-gray-200 dark:border-slate-700 cursor-pointer" onclick="showRecordDetails(${index})" title="Click to view details">
            ${columnMapping.map(([displayName, fieldNames]) => {
                const value = getFieldValue(record, fieldNames);
                const displayValue = formatValue(value, displayName);
                return `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-slate-200">${displayValue}</td>`;
            }).join('')}
        </tr>`;
    }).join('');
    
    // Update record count
    const recordsCount = document.getElementById('records-count');
    if (recordsCount) {
        recordsCount.textContent = records.length;
    }
}

// Function to filter records table
function filterRecordsTable() {
    const searchInput = document.getElementById('records-search-input');
    if (!searchInput) return;
    
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    if (!allRecordsData || allRecordsData.length === 0) {
        return;
    }
    
    // If search is empty, show all records
    if (searchTerm === '') {
        renderTableRecords(allRecordsData);
        return;
    }
    
    // Filter records by Mobile, Name (FULLNAME), or PAN
    const filteredRecords = allRecordsData.filter(record => {
        // Get Mobile value
        const mobileFieldNames = ['mobile', 'Mobile', 'MOBILE', 'phone', 'Phone', 'mobile_number', 'contact_number'];
        const mobileValue = getFieldValue(record, mobileFieldNames);
        const mobileStr = mobileValue ? String(mobileValue).toLowerCase() : '';
        
        // Get Name (FULLNAME) value
        const nameFieldNames = ['fullname', 'FullName', 'full_name', 'FULLNAME', 'name', 'Name', 'customer_name'];
        const nameValue = getFieldValue(record, nameFieldNames);
        const nameStr = nameValue ? String(nameValue).toLowerCase() : '';
        
        // Get PAN value
        const panFieldNames = ['pan', 'PAN', 'Pan', 'pan_number', 'PAN_Number'];
        const panValue = getFieldValue(record, panFieldNames);
        const panStr = panValue ? String(panValue).toLowerCase() : '';
        
        // Check if search term matches any of these fields
        return mobileStr.includes(searchTerm) || 
               nameStr.includes(searchTerm) || 
               panStr.includes(searchTerm);
    });
    
    // Render filtered records
    renderTableRecords(filteredRecords);
    
    // Show "No results" message if no matches
    if (filteredRecords.length === 0) {
        const tableBody = document.getElementById('records-table-body');
        if (tableBody) {
            const columnCount = columnMapping.length;
            tableBody.innerHTML = `<tr><td colspan="${columnCount}" class="px-6 py-4 text-center text-gray-500 dark:text-slate-400">No records found matching "${searchTerm}"</td></tr>`;
        }
    }
}

// Function to show record details
function showRecordDetails(index) {
    if (!window.currentDisplayedRecords || !window.currentDisplayedRecords[index]) {
        return;
    }
    
    const record = window.currentDisplayedRecords[index];
    const modal = document.getElementById('record-details-modal');
    const content = document.getElementById('record-details-content');
    
    if (!modal || !content) return;
    
    // Build key-value pairs
    let html = '';
    columnMapping.forEach(([displayName, fieldNames]) => {
        const value = getFieldValue(record, fieldNames);
        const displayValue = formatValue(value, displayName);
        
        html += `
            <div class="flex flex-col sm:flex-row sm:items-center border-b border-gray-200 dark:border-slate-700 pb-3 last:border-b-0">
                <div class="font-semibold text-sm text-gray-700 dark:text-slate-300 mb-1 sm:mb-0 sm:w-1/3 sm:pr-4" style="color: #00072D;">
                    ${displayName}:
                </div>
                <div class="text-sm text-gray-900 dark:text-slate-200 sm:w-2/3 break-words">
                    ${displayValue || '-'}
                </div>
            </div>
        `;
    });
    
    content.innerHTML = html;
    modal.classList.remove('hidden');
}

// Function to close record details modal
function closeRecordDetails() {
    const modal = document.getElementById('record-details-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const recordDetailsModal = document.getElementById('record-details-modal');
        if (recordDetailsModal && !recordDetailsModal.classList.contains('hidden')) {
            closeRecordDetails();
        } else {
            closeRecordsTable();
        }
    }
});

// Export table data to Excel (CSV format)
function exportToExcel() {
    const table = document.querySelector('#records-table-container table');
    if (!table) {
        alert('No data available to export');
        return;
    }
    
    const headers = [];
    const headerRow = table.querySelector('thead tr');
    if (headerRow) {
        headerRow.querySelectorAll('th').forEach(th => {
            headers.push(th.textContent.trim());
        });
    }
    
    if (headers.length === 0) {
        alert('No data available to export');
        return;
    }
    
    const rows = [];
    const bodyRows = table.querySelectorAll('tbody tr');
    
    bodyRows.forEach(row => {
        const rowData = [];
        row.querySelectorAll('td').forEach(td => {
            let cellValue = td.textContent.trim();
            // Remove rupee sign and other formatting for export
            cellValue = cellValue.replace(/₹/g, '').replace(/,/g, '');
            rowData.push(cellValue);
        });
        if (rowData.length > 0) {
            rows.push(rowData);
        }
    });
    
    if (rows.length === 0) {
        alert('No data available to export');
        return;
    }
    
    // Create CSV content
    let csvContent = '';
    
    // Add headers
    csvContent += headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + '\n';
    
    // Add rows
    rows.forEach(row => {
        csvContent += row.map(cell => {
            // Escape quotes and wrap in quotes
            const escaped = String(cell).replace(/"/g, '""');
            return `"${escaped}"`;
        }).join(',') + '\n';
    });
    
    // Create BOM for UTF-8 (Excel compatibility)
    const BOM = '\uFEFF';
    csvContent = BOM + csvContent;
    
    // Create blob and download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    // Generate filename with current date
    const today = new Date();
    const dateStr = today.toISOString().split('T')[0];
    const filename = `disbursal_records_${dateStr}.csv`;
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Show success message
    const exportBtn = document.getElementById('export-excel-btn');
    if (exportBtn) {
        const originalHTML = exportBtn.innerHTML;
        exportBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Exported!';
        exportBtn.style.backgroundColor = '#10b981';
        setTimeout(() => {
            exportBtn.innerHTML = originalHTML;
        }, 2000);
    }
}
</script>
{% endblock %}

