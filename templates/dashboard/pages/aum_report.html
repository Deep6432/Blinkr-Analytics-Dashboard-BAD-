{% extends 'dashboard/base.html' %}
{% load static %}
{% load humanize %}
{% load indian_number %}

{% block title %}AUM Report - Blinkr Analytics Dashboard{% endblock %}

{% block page_title %}AUM Report{% endblock %}
{% block page_subtitle %}Assets Under Management (Monthly View){% endblock %}

{% block kpi_cards %}
{# No KPI cards for AUM Report yet - can be added later if needed #}
{% endblock %}

{% block content %}
<div class="space-y-4">
    {% if api_error %}
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md px-3 py-2 text-xs text-red-700 dark:text-red-200">
            <strong>API Error:</strong> {{ api_error }}
        </div>
    {% endif %}

    <!-- AUM Report Table -->
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md border border-gray-200 dark:border-slate-700 overflow-hidden">
        <!-- Compact header strip above table for context -->
        <div class="flex items-center justify-between px-3 py-1.5 border-b border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/40 text-[11px]">
            <div class="flex items-center gap-2 text-slate-700 dark:text-slate-200">
                <span class="inline-block w-1 h-4 rounded-full bg-emerald-500"></span>
                <span class="font-medium tracking-wide">AUM (month-wise summary)</span>
            </div>
            <div class="flex items-center gap-3">
                <div class="hidden sm:flex items-center gap-3 text-[10px] text-slate-500">
                    <span>Units = # Cases</span>
                    <span class="w-px h-3 bg-slate-300"></span>
                    <span>Sum = â‚¹ (Indian format)</span>
                </div>
                <button 
                    onclick="exportAumToExcel()" 
                    id="export-aum-excel-btn" 
                    class="ml-3 px-3 py-1.5 text-xs font-medium text-white rounded-lg transition-colors hover:opacity-90 flex items-center gap-1.5" 
                    style="background-color: #10b981;"
                >
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Export Excel
                </button>
            </div>
        </div>
        <div class="overflow-x-auto aum-scroll" style="max-height: 70vh;">
            <table class="min-w-full border-collapse text-[11px] leading-tight" id="aum-report-table">
                <!-- Title Row - Must span all columns: 1 (Category) + (months * 2) = 1 + 2*months -->
                <thead>
                    <tr>
                        <th colspan="{{ sorted_months|length|add:sorted_months|length|add:1 }}"
                            id="aum-report-title"
                            class="bg-slate-900 text-white font-medium py-2 px-4 text-[11px] tracking-wide border-b border-slate-800"
                            style="text-align: center !important; width: 100%;">
                            <div style="text-align: center; margin: 0 auto; display: block;">AUM REPORT</div>
                        </th>
                    </tr>
                </thead>

                <!-- Header Row 1: Category + Months -->
                <thead>
                    <tr>
                        <th rowspan="2"
                            class="bg-slate-800 text-white text-left font-medium py-2 px-3 border border-slate-600 sticky left-0 z-20 text-[11px] min-w-[190px]">
                            <span class="uppercase tracking-wide text-[10px] text-slate-200">Category</span>
                        </th>
                        {% for month in sorted_months %}
                            <th colspan="2"
                                class="bg-slate-800 text-slate-100 text-center font-medium py-2 px-2 border border-slate-700 text-[11px] min-w-[112px]">
                                <span class="tracking-wide">{{ month|upper }}</span>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>

                <!-- Header Row 2: Units + Sum for each month -->
                <thead>
                    <tr>
                        <th class="bg-slate-800 text-white py-1.5 px-3 border border-slate-700 sticky left-0 z-20"></th>
                        {% for month in sorted_months %}
                            <th class="bg-slate-100 text-slate-700 text-center font-medium py-1.5 px-2 border border-slate-200 text-[10px] uppercase">
                                Units
                            </th>
                            <th class="bg-slate-100 text-slate-700 text-center font-medium py-1.5 px-2 border border-slate-200 text-[10px] uppercase">
                                Sum
                            </th>
                        {% endfor %}
                    </tr>
                </thead>

                <tbody>
                    {% if monthly_data_list and sorted_months and sorted_months|length > 0 %}
                        <!-- Helper classes: compact rows, subtle zebra striping -->

                        <!-- STPL (SHORT TERM PERSONAL LOAN) -->
                        <tr class="bg-white even:bg-slate-50 hover:bg-blue-50/60 transition-colors">
                            <td class="border border-slate-200 px-3 py-1.5 font-medium text-slate-900 sticky left-0 bg-inherit z-10">
                                STPL (SHORT TERM PERSONAL LOAN)
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% with data=month_item.data %}
                                    <td class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.stpl_units|default:0|indian_int }}
                                    </td>
                                    <td class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.stpl_sum|default:0|floatformat:0|indian_int }}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>

                        <!-- Loan Disbursed - REPEAT -->
                        <tr class="bg-white even:bg-slate-50 hover:bg-blue-50/60 transition-colors">
                            <td class="border border-slate-200 px-3 py-1.5 font-medium text-slate-900 sticky left-0 bg-inherit z-10">
                                Loan Disbursed - REPEAT
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% with data=month_item.data %}
                                    <td class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.loan_disbursed_repeat_units|default:0|indian_int }}
                                    </td>
                                    <td class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.loan_disbursed_repeat_sum|default:0|floatformat:0|indian_int }}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>

                        <!-- Loan Disbursed - Total -->
                        <tr class="bg-white even:bg-slate-50 hover:bg-blue-50/60 transition-colors">
                            <td class="border border-slate-200 px-3 py-1.5 font-semibold text-slate-900 sticky left-0 bg-inherit z-10">
                                Loan Disbursed - Total
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% with data=month_item.data %}
                                    <td class="border border-slate-200 px-2 py-1.5 text-right font-semibold text-slate-900">
                                        {{ data.loan_disbursed_total_units|default:0|indian_int }}
                                    </td>
                                    <td class="border border-slate-200 px-2 py-1.5 text-right font-semibold text-slate-900">
                                        {{ data.loan_disbursed_total_sum|default:0|floatformat:0|indian_int }}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>

                        <!-- ATS (spans both Units and Sum) -->
                        <tr class="bg-slate-50 hover:bg-slate-100 transition-colors">
                            <td class="border border-slate-200 px-3 py-1.5 font-medium text-slate-900 sticky left-0 bg-inherit z-10">
                                ATS (Average Ticket Size)
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% with data=month_item.data %}
                                    <td colspan="2" class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.ats|default:0|floatformat:2|indian_number }}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>

                        <!-- Running Cases -->
                        <tr class="bg-white even:bg-slate-50 hover:bg-blue-50/60 transition-colors">
                            <td class="border border-slate-200 px-3 py-1.5 font-medium text-slate-900 sticky left-0 bg-inherit z-10">
                                Running Cases
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% with data=month_item.data %}
                                    <td class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.running_cases_units|default:0|indian_int }}
                                    </td>
                                    <td class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.running_cases_sum|default:0|floatformat:0|indian_int }}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>

                        <!-- Over Due +1-30 Day -->
                        <tr class="bg-white even:bg-slate-50 hover:bg-blue-50/60 transition-colors">
                            <td class="border border-slate-200 px-3 py-1.5 font-medium text-slate-900 sticky left-0 bg-inherit z-10">
                                Over Due +1-30 Day
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% with data=month_item.data %}
                                    <td class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.overdue_1_30_units|default:0|indian_int }}
                                    </td>
                                    <td class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.overdue_1_30_sum|default:0|floatformat:0|indian_int }}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>

                        <!-- Over Due +31-90 Day -->
                        <tr class="bg-white even:bg-slate-50 hover:bg-blue-50/60 transition-colors">
                            <td class="border border-slate-200 px-3 py-1.5 font-medium text-slate-900 sticky left-0 bg-inherit z-10">
                                Over Due +31-90 Day
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% with data=month_item.data %}
                                    <td class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.overdue_31_90_units|default:0|indian_int }}
                                    </td>
                                    <td class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.overdue_31_90_sum|default:0|floatformat:0|indian_int }}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>

                        <!-- Over Due 90+ Day -->
                        <tr class="bg-white even:bg-slate-50 hover:bg-blue-50 transition-colors">
                            <td class="border border-slate-200 px-3 py-1.5 font-medium text-slate-900 sticky left-0 bg-inherit z-10">
                                Over Due 90+ Day
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% with data=month_item.data %}
                                    <td class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.overdue_90_plus_units|default:0|indian_int }}
                                    </td>
                                    <td class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.overdue_90_plus_sum|default:0|floatformat:0|indian_int }}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>

                        <!-- Loan Book(AUM) - Highlighted in pale yellow -->
                        <tr class="bg-amber-50 hover:bg-amber-100 transition-colors">
                            <td class="border border-amber-200 px-3 py-1.5 font-semibold text-slate-900 sticky left-0 bg-inherit z-10">
                                Loan Book(AUM)
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% with data=month_item.data %}
                                    <td class="border border-amber-200 px-2 py-1.5 text-right font-semibold text-slate-900">
                                        {{ data.loan_book_aum_units|default:0|indian_int }}
                                    </td>
                                    <td class="border border-amber-200 px-2 py-1.5 text-right font-semibold text-slate-900">
                                        {{ data.loan_book_aum_sum|default:0|floatformat:0|indian_int }}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>

                        <!-- PF Income (Incl. GST) -->
                        <tr class="bg-white even:bg-slate-50 hover:bg-blue-50/60 transition-colors">
                            <td class="border border-slate-200 px-3 py-1.5 font-medium text-slate-900 sticky left-0 bg-inherit z-10">
                                PF Income (Incl. GST)
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% with data=month_item.data %}
                                    <td colspan="2" class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.pf_income|default:0|floatformat:2|indian_number }}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>

                        <!-- Interest Income -->
                        <tr class="bg-white even:bg-slate-50 hover:bg-blue-50/60 transition-colors">
                            <td class="border border-slate-200 px-3 py-1.5 font-medium text-slate-900 sticky left-0 bg-inherit z-10">
                                Interest Income
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% with data=month_item.data %}
                                    <td colspan="2" class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.interest_income|default:0|floatformat:2|indian_number }}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>

                        <!-- Avg PF (Incl. GST) -->
                        <tr class="bg-white even:bg-slate-50 hover:bg-blue-50/60 transition-colors">
                            <td class="border border-slate-200 px-3 py-1.5 font-medium text-slate-900 sticky left-0 bg-inherit z-10">
                                Avg PF (Incl. GST)
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% with data=month_item.data %}
                                    <td colspan="2" class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.avg_pf|default:0|floatformat:2|indian_number }}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>

                        <!-- Avg ROI -->
                        <tr class="bg-white even:bg-slate-50 hover:bg-blue-50/60 transition-colors">
                            <td class="border border-slate-200 px-3 py-1.5 font-medium text-slate-900 sticky left-0 bg-inherit z-10">
                                Avg ROI
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% with data=month_item.data %}
                                    <td colspan="2" class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.avg_roi|default:0|floatformat:2 }}%
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>

                        <!-- Avg Tenure -->
                        <tr class="bg-white even:bg-slate-50 hover:bg-blue-50 transition-colors">
                            <td class="border border-slate-200 px-3 py-1.5 font-medium text-slate-900 sticky left-0 bg-inherit z-10">
                                Avg Tenure
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% with data=month_item.data %}
                                    <td colspan="2" class="border border-slate-200 px-2 py-1.5 text-right text-slate-800">
                                        {{ data.avg_tenure|default:0|floatformat:2|indian_number }}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>

                        <!-- Total Loan Book AUM -->
                        <tr class="bg-blue-50 hover:bg-blue-100 transition-colors">
                            <td class="border border-blue-200 px-3 py-1.5 font-semibold text-blue-900 sticky left-0 bg-inherit z-10">
                                Total Loan Book AUM
                            </td>
                            {% for month_item in monthly_data_list %}
                                {% if forloop.last %}
                                    <td class="border border-blue-200 px-2 py-1.5"></td>
                                    <td class="border border-blue-200 px-2 py-1.5 text-right font-semibold text-blue-900">
                                        {{ total_loan_book_aum|default:0|floatformat:0|indian_int }}
                                    </td>
                                {% else %}
                                    <td class="border border-blue-50 px-2 py-1.5"></td>
                                    <td class="border border-blue-50 px-2 py-1.5"></td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="20" class="border border-slate-200 px-4 py-10 text-center text-slate-500 text-xs">
                                {% if api_error %}
                                    <div class="text-red-600 font-medium mb-1.5">API Error: {{ api_error }}</div>
                                {% endif %}
                                <div>No monthly data available for the selected range.</div>
                                {% if aum_data_total > 0 %}
                                    <div class="text-[10px] mt-1 text-slate-400">Total rows received: {{ aum_data_total|intcomma }}</div>
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Fallback: Show Raw Data if Monthly Processing Failed -->
    {% if aum_data_preview and aum_data_preview|length > 0 and not monthly_data_list %}
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-4 mt-4">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-sm font-semibold text-gray-900 dark:text-white">
                    Raw AUM Data (Monthly processing unavailable)
                </h2>
                <p class="text-[10px] text-gray-500 dark:text-slate-400">
                    Showing first {{ aum_data_preview_limit }} of {{ aum_data_total|default:"0"|intcomma }} rows
                </p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700 text-[11px]">
                    <thead class="bg-gray-50 dark:bg-slate-900">
                        <tr>
                            {% for key in aum_data_preview.0.keys %}
                                <th class="px-3 py-2 text-left text-[10px] font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wide">
                                    {{ key|title }}
                                </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-slate-800 divide-y divide-gray-200 dark:divide-slate-700">
                        {% for item in aum_data_preview %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-slate-700">
                                {% for key, value in item.items %}
                                    <td class="px-3 py-1.5 whitespace-nowrap text-[11px] text-gray-900 dark:text-slate-200">
                                        {% if value is None %}
                                            -
                                        {% elif value|floatformat:0 == value|floatformat:2 %}
                                            {{ value|floatformat:0|intcomma }}
                                        {% else %}
                                            {{ value|floatformat:2|intcomma }}
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}
</div>

<style>
    /* Force center alignment for AUM REPORT title - Maximum specificity */
    table#aum-report-table thead:first-child tr:first-child th#aum-report-title {
        text-align: center !important;
        text-align-last: center !important;
        text-indent: 0 !important;
    }
    /* Override any inherited text alignment */
    #aum-report-table thead tr:first-child th {
        text-align: center !important;
    }
    /* Ensure the cell content is centered */
    #aum-report-title,
    #aum-report-title *,
    #aum-report-title div {
        text-align: center !important;
        margin-left: auto !important;
        margin-right: auto !important;
        display: block !important;
    }
    /* Override any Tailwind or base template styles */
    .bg-slate-900#aum-report-title {
        text-align: center !important;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
// Provide cities-by-state mapping for the shared filter panel city filtering logic.
window.citiesByState = JSON.parse('{{ cities_by_state_json|default:"{}"|escapejs }}');// Force center alignment for AUM REPORT title
document.addEventListener('DOMContentLoaded', function() {
    function centerTitle() {
        const titleCell = document.getElementById('aum-report-title');
        if (titleCell) {
            // Remove any left-alignment classes
            titleCell.classList.remove('text-left');
            // Force center alignment
            titleCell.style.textAlign = 'center';
            titleCell.style.textAlignLast = 'center';
            titleCell.style.marginLeft = 'auto';
            titleCell.style.marginRight = 'auto';
            titleCell.setAttribute('align', 'center');
            
            // Center the div inside
            const div = titleCell.querySelector('div');
            if (div) {
                div.style.textAlign = 'center';
                div.style.margin = '0 auto';
                div.style.width = '100%';
            }
        }
    }
    
    centerTitle();
    // Also run after delays to override any late-loading styles
    setTimeout(centerTitle, 100);
    setTimeout(centerTitle, 500);
});

// Export AUM Report table to Excel (CSV format)
function exportAumToExcel() {
    const table = document.querySelector('.aum-scroll table');
    if (!table) {
        alert('No data available to export');
        return;
    }
    
    // Build headers from the table structure
    const headers = ['Category'];
    const theadRows = table.querySelectorAll('thead tr');
    
    // Get month headers from the second header row (Category + Months)
    if (theadRows.length >= 2) {
        const monthHeaders = theadRows[1].querySelectorAll('th[colspan="2"]');
        monthHeaders.forEach(th => {
            const monthText = th.textContent.trim();
            headers.push(monthText + ' - Units');
            headers.push(monthText + ' - Sum');
        });
    }
    
    if (headers.length === 0) {
        alert('No headers found in table');
        return;
    }
    
    // Collect all data rows
    const rows = [];
    const tbodyRows = table.querySelectorAll('tbody tr');
    
    tbodyRows.forEach(row => {
        const rowData = [];
        const cells = row.querySelectorAll('td');
        
        cells.forEach(td => {
            let cellValue = td.textContent.trim();
            // Clean up whitespace
            cellValue = cellValue.replace(/\s+/g, ' ');
            rowData.push(cellValue);
        });
        
        // Only add rows that have data (skip empty rows)
        if (rowData.length > 0 && rowData.some(cell => cell !== '')) {
            rows.push(rowData);
        }
    });
    
    if (rows.length === 0) {
        alert('No data available to export');
        return;
    }
    
    // Create CSV content
    let csvContent = '';
    
    // Add title row
    csvContent += '"AUM REPORT"\n';
    
    // Add empty row for spacing (optional)
    csvContent += '\n';
    
    // Add headers
    csvContent += headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + '\n';
    
    // Add rows
    rows.forEach(row => {
        // Ensure row has same number of columns as headers (pad if needed)
        while (row.length < headers.length) {
            row.push('');
        }
        // Trim to match header count
        row = row.slice(0, headers.length);
        
        csvContent += row.map(cell => {
            // Escape quotes and wrap in quotes
            const escaped = String(cell).replace(/"/g, '""');
            return `"${escaped}"`;
        }).join(',') + '\n';
    });
    
    // Create BOM for UTF-8 (Excel compatibility)
    const BOM = '\uFEFF';
    csvContent = BOM + csvContent;
    
    // Create blob and download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    // Generate filename with current date
    const today = new Date();
    const dateStr = today.toISOString().split('T')[0];
    const filename = `aum_report_${dateStr}.csv`;
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Show success message
    const exportBtn = document.getElementById('export-aum-excel-btn');
    if (exportBtn) {
        const originalHTML = exportBtn.innerHTML;
        exportBtn.innerHTML = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Exported!';
        exportBtn.style.backgroundColor = '#10b981';
        setTimeout(() => {
            exportBtn.innerHTML = originalHTML;
        }, 2000);
    }
}
</script>
{% endblock %}